---
title: "ERA5_dataset_refinement"
author: "Elsa Barrio Torres"
format: html
editor: visual
---

The raw data used in this file was obtained running the previous Python file ''2-Convert_ERA5_nc_to_csv.ipynb''. This raw data will be deleted at the end of this file, and a refined version will be saved.

## Read .csv files with ERA-5 data

Read the .csv files containing data geopotential hight at pressure levels of 300hPa, 500hPa, 700hPa, and 850hPa.

```{r message = FALSE, warning = FALSE}

# Set data directory
data_dir <- "../../../Data/Raw.csv"
if(!dir.exists(data_dir)) stop("Raw data not found or already removed")

# Read .csv files for geopotential hight at pressure levels of 300hPa, 500hPa, 700hPa, and 850hPa.
g_300 <- read.csv(file = file.path(data_dir,"geopotential300.csv"))
g_500 <- read.csv(file = file.path(data_dir,"geopotential500.csv"))
g_700 <- read.csv(file = file.path(data_dir,"geopotential700.csv"))
g_850 <- read.csv(file = file.path(data_dir,"geopotential850.csv"))

```

## Keep data where expver = 1

Now only the data where the parameter **expver** is equal to **1** is kept. expver stands for Experiment Version, and takes values of 1 or 5. expver = 1 refers to the main or primary stream of the ERA5 dataset, while expver = 5 is an extension of the data.

```{r message = FALSE, warning = FALSE}

# Keep only the data where expver = 1
aux_g_300 <- g_300[which(g_300$expver==1),]
aux_g_500 <- g_500[which(g_500$expver==1),]
aux_g_700 <- g_700[which(g_700$expver==1),]
aux_g_850 <- g_850[which(g_850$expver==1),]

```

## Create vectors with variable data

Now, a vector with the data for each variable is kept, and three additional vectors with the latitudes, the longitudes, and the dates.

```{r message = FALSE, warning = FALSE}

# Create vectors with geopotential hight data only
save_g_300<- aux_g_300[,"z"]
save_g_500<- aux_g_500[,"z"]
save_g_700<- aux_g_700[,"z"]
save_g_850<- aux_g_850[,"z"]

# Create vectors with latitude, longitude, and dates data only
lon <- aux_t_300[,"longitude"]
lat <- aux_t_300[,"latitude"]
DATE <- aux_t_300[,"Date"]

```

## Saved refined data and delete raw data

Now save the vectors created in .rds objects, and delete the folder with the raw .csv data.

```{r message = FALSE, warning = FALSE}

# Create folder to save the data if it does not exist
outdir <- "../../../Data/geo.data/"
if (!dir.exists(outdir)) {dir.create(outdir)}

# Save latitude, longitude, and date data 
saveRDS(object = lon, file = file.path(outdir,"lon.rds"))
saveRDS(object = lat, file = file.path(outdir,"lat.rds"))
saveRDS(object = DATE, file = file.path(outdir,"Date.rds"))

# Save geopotential hight data
saveRDS(object = save_g_300, file = file.path(outdir,"g_300_12pm_60_23.rds"))
saveRDS(object = save_g_500, file = file.path(outdir,"g_500_12pm_60_23.rds"))
saveRDS(object = save_g_700, file = file.path(outdir,"g_700_12pm_60_23.rds"))
saveRDS(object = save_g_850, file = file.path(outdir,"g_850_12pm_60_23.rds"))

```

```{r message = FALSE, warning = FALSE}
# Delete raw .csv and .nc data
raw.csv <- "../../../Data/Raw.csv"
raw.nc <- "../../../Data/Raw.nc"

unlink(raw.csv, recursive = TRUE)
unlink(raw.nc, recursive = TRUE)
```
