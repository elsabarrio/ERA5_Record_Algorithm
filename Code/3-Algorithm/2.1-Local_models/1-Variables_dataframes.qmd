---
title: "1-Data_frames_construction"
format: html
editor: visual
---

## Data frames construction

This piece of code created a folder called local.dataframes inside the Data folder containing 36 data frames (one for each station) with maximum temperature record and geopotential variables for the years between 1960-2023 in the summer months of June, July, and August. The columns of the data frames are the variables and the rows the days.

## Setting records

The first step before constructing the data frames is to use maximum temperature data to obtain records as a binary variable that will serve as the target variable in the models.

```{r message = FALSE, warning = FALSE}
# Clear workspace
rm(list = ls())

# Set data directory
data_dir <- "../../../Data"
if(!dir.exists(data_dir)) stop("data_dir not found")

# Read list of observatories of interest. Based on previous work.
stations <- read.csv(file.path(data_dir,"geo_peninsula_zones.csv"))
idx <- which(!is.na(stations$Zona))
stations <- stations[idx,]

# Read records data
itx3d <- readRDS(file = file.path(data_dir,"record.data","recordvol.rds"))
voldim <- dim(itx3d)
```

## Refine station names

Now we wanted to modify some of the names of the stations and abbreviate all of them for simplicity.

```{r message = FALSE, warning = FALSE}

# Modify and stations names and create abbreviations
stations$STANAME[10] <- "FABRA OBSERVATORY                       "
stations$STANAME[25] <- "BCN/AEROPUERTO                          "
stations$abb <- substr(stations$STANAME,1,6)

```

## Saving data frames for each station

The last step is to loop over each station and generate a data frame containing the data for all the variables for the summer season from 1960-2023 and save them as .csv. These will be used to construct a local model for each station.

```{r message = FALSE, warning = FALSE}

# Define functions directori
functions_dir <- "../../../R"

# Out directory
outdir <- file.path(data_dir, "local.dataframes")
if(!dir.exists(outdir)){
  
  # Create directory to save the dataframes
  dir.create(outdir, recursive = T)
  
  # Start loop if the folder does not already exist
  source(file.path(functions_dir,"atm_var_station.R"))

  # Define global inputs
  days <- c("06-01", "08-31") # Summer days
  altitudes <- c("300", "500", "700") # Define pressure levels
  variable <- "g" # Define variable
  folder <- file.path(data_dir,"geo.data") # Define folder containing the raw data
  
  # Load library
  if(!is.element("data.table", row.names(installed.packages()))){
      install.packages("data.table")
    }
  library(data.table)
  
  # For each station
  for(ss in 1:length(stations$STANAME)){
    ss <- 2
    # Define all the inputs for the function
    sta_name <- stations$abb[ss] # Get station name
    sta_id <- stations$STAID[ss] # Get station ID
    
    # Create data frame for specific station using function
    tic <- Sys.time()
    bin_df <-  atm_var_station(sta_name,
                               data_dir,
                               functions_dir,
                               altitudes,
                               variable,
                               folder,
                               itx3d,
                               stations,
                               days)
    toc <- Sys.time()
    print(toc-tic)
    
    # Remove first year
    #bin_df <- bin_df[which(bin_df$t>1),]
    # Add trend (logistic)
    bin_df$trend <- log(bin_df$t-1)
    # Add lag1
    bin_df$Ix.lag1 <- dplyr::lag(bin_df$Ix, 1, 0)
  
    # Save dataframe
    fwrite(x = bin_df, file = file.path(outdir, paste0(sta_id,".df.csv")))
  
  }# for ss stations
}# if outdir exists

```
